<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hub.root.main.mybatis.mainMapper">
<resultMap type="com.hub.root.main.dto.MainDTO" id="main">
	<id property="store_id" column="store_id"/>
	<result property="store_menu_img" column="store_menu_img"/>
	<result property="store_menu_name" column="store_menu_name"/>
	<result property="store_menu_detail" column="store_menu_detail"/>
	<result property="store_menu_category" column="store_menu_category"/>
	<result property="store_menu_price" column="store_menu_price"/>
</resultMap>
<insert id="infoSave">
	insert into store_menu(store_id, store_menu_img, store_menu_name, store_menu_price,
		store_menu_detail, store_menu_category) values(#{store_id},#{store_menu_img},
		#{store_menu_name},#{store_menu_price},#{store_menu_detail},#{store_menu_category})
</insert>
<select id="mainPage1" resultMap="main">
	select * from store_menu
</select>
<!-- 아이디 검색시 성공
<select id="search" resultMap="main">
	select * from store_menu where store_menu_name in
	<foreach item="id" collection="list" open="(" separator="," close=")">
		#{id}
	</foreach>
</select>
 -->
 <!-- 메뉴이름만 검색할때의 쿼리 성공 
<select id="search" resultMap="main">
    SELECT * FROM store_menu
    <where>
        <if test="store_menu_name != null and store_menu_name.size() > 0">
            AND store_menu_name IN
            <foreach item="name" collection="store_menu_name" open="(" separator="," close=")">
                #{name}
            </foreach>
        </if>
    </where>
</select>
-->
<!-- 메뉴이름 또는 종류검색시 검색 성공 쿼리
<select id="search" resultMap="main">
    SELECT * FROM store_menu
    <where>
        <if test="keyword != null and keyword != ''">
            (store_menu_name LIKE '%' || #{keyword} || '%'
            OR store_menu_category LIKE '%' || #{keyword} || '%')
        </if>
    </where>
</select>
 -->
 <!-- 전체, 메뉴이름 또는 종류검색시 검색 (드롭다운을 통한) 성공 쿼리  
<select id="search" resultMap="main">
        SELECT * FROM store_menu
        <where>
            <if test="params.keyword != null and params.keyword != ''">
                <choose>
                    <when test="params.searchType == 'menu_name'">
                        store_menu_name LIKE '%' || #{params.keyword} || '%'
                    </when>
                    <when test="params.searchType == 'menu_category'">
                        store_menu_category LIKE '%' || #{params.keyword} || '%'
                    </when>
                    <otherwise>
                        store_menu_name LIKE '%' || #{params.keyword} || '%'
                        OR store_menu_category LIKE '%' || #{params.keyword} || '%'
                    </otherwise>
                </choose>
            </if>
        </where>
    </select>
    -->
<!-- 카테고리 필터링 -->
<select id="search" resultMap="main">
    SELECT * FROM store_menu
    <where>
        <if test="params.keyword != null and params.keyword != ''">
            <choose>
            	<!-- 검색유형 메뉴이름일 경우 -->
                <when test="params.searchType == 'menu_name'">
                	<!-- store_menu_name 컬럼이 검색 키워드를 포함하는 레코드 찾음 -->
                    store_menu_name LIKE '%' || #{params.keyword} || '%'
                </when>
                <!-- 검색유형 메뉴 카테고리일 경우 -->
                <when test="params.searchType == 'menu_category'">
                    EXISTS (
                        <!-- store_menu_category 컬러의 값을 '/'로 구분하여 각 부분을 검색 키워드와 비교 -->
                        SELECT 1 FROM dual
                        <!-- store_menu_category 값을 '/'로 구분하여 각 부분을 추출 -->
                        WHERE REGEXP_SUBSTR(store_menu_category, '[^/]+', 1, LEVEL) = #{params.keyword}
                        <!-- oracle sql의 쿼리 구조를 사용하여 '/'로 구분된 모든 부분을 순차적으로 비교 -->
                        CONNECT BY REGEXP_SUBSTR(store_menu_category, '[^/]+', 1, LEVEL) IS NOT NULL
                    )
                </when>
                <!-- 검색유형이 지정되지 않았거나 다른 경우 -->
                <otherwise>
                    store_menu_name LIKE '%' || #{params.keyword} || '%'
                    OR EXISTS (
                        SELECT 1 FROM dual
                        WHERE REGEXP_SUBSTR(store_menu_category, '[^/]+', 1, LEVEL) = #{params.keyword}
                        CONNECT BY REGEXP_SUBSTR(store_menu_category, '[^/]+', 1, LEVEL) IS NOT NULL
                    )
                </otherwise>
            </choose>
        </if>
    </where>
</select>
</mapper>











